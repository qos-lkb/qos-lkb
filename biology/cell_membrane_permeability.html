<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´°èƒè†œç©¿é€æ€§æ¨¡æ“¬æ•™å­¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax for rendering chemical formulas -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: manipulation;
        }
        .lipid-head {
            fill: #60A5FA; /* Blue-400 */
            stroke: #2563EB; /* Blue-600 */
            stroke-width: 2;
        }
        .lipid-tail {
            stroke: #FCD34D; /* Yellow-300 */
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
        }
        .protein {
            fill: #A78BFA; /* Purple-400 */
            stroke: #7C3AED; /* Purple-600 */
            stroke-width: 3;
        }
        .particle {
            transition: opacity 0.5s;
        }
        .fade-out {
            opacity: 0;
        }
        /* Style adjustments for MathJax to blend in buttons */
        mjx-container {
            font-size: 1.1em !important;
            color: inherit !important;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
    <header class="w-full max-w-4xl text-center mb-6">
        <h1 class="text-3xl font-bold text-slate-800 mb-2">ğŸ§¬ ç´°èƒè†œç‰©è³ªç©¿é€æ¨¡æ“¬</h1>
        <p class="text-slate-600">æµé«”é‘²åµŒæ¨¡å‹ï¼šç‰©è³ªé€²å‡ºç´°èƒçš„æ©Ÿåˆ¶</p>
    </header>

    <!-- Main Interface -->
    <main class="w-full max-w-4xl bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
        
        <!-- Controls Area -->
        <div class="bg-slate-100 p-4 border-b border-slate-200">
            
            <!-- Import Section -->
            <div class="mb-4">
                <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">é€²å…¥ç´°èƒ (Import)</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button onclick="startSimulation('oxygen', 'in')" class="flex flex-col items-center justify-center p-3 bg-white hover:bg-blue-50 border border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 group">
                        <div class="w-4 h-4 rounded-full bg-red-500 mb-2"></div>
                        <span class="font-medium text-slate-700 group-hover:text-blue-600">æ°§æ°£ (\(O_2\))</span>
                    </button>
                    <button onclick="startSimulation('water', 'in')" class="flex flex-col items-center justify-center p-3 bg-white hover:bg-blue-50 border border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 group">
                        <div class="w-4 h-4 rounded-full bg-blue-400 mb-2"></div>
                        <span class="font-medium text-slate-700 group-hover:text-blue-600">æ°´ (\(H_2O\))</span>
                    </button>
                    <button onclick="startSimulation('glucose', 'in')" class="flex flex-col items-center justify-center p-3 bg-white hover:bg-blue-50 border border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 group">
                        <div class="w-6 h-6 rotate-45 border-2 border-green-600 bg-green-100 mb-1"></div>
                        <span class="font-medium text-slate-700 group-hover:text-blue-600">è‘¡è„ç³–</span>
                    </button>
                    <button onclick="startSimulation('ion_na', 'in')" class="flex flex-col items-center justify-center p-3 bg-white hover:bg-blue-50 border border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 group">
                        <div class="w-5 h-5 rounded-full border-2 border-orange-500 flex items-center justify-center text-[10px] font-bold text-orange-600 mb-1">Na<sup>+</sup></div>
                        <span class="font-medium text-slate-700 group-hover:text-blue-600">éˆ‰é›¢å­ (\(Na^+\))</span>
                    </button>
                </div>
            </div>

            <!-- Export Section -->
            <div>
                <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">é›¢é–‹ç´°èƒ (Export)</h2>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="startSimulation('co2', 'out')" class="flex items-center justify-center space-x-3 p-3 bg-white hover:bg-pink-50 border border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 group">
                        <div class="w-5 h-4 rounded-lg bg-gray-500"></div>
                        <span class="font-medium text-slate-700 group-hover:text-pink-600">äºŒæ°§åŒ–ç¢³ (\(CO_2\))</span>
                    </button>
                    <button onclick="startSimulation('ion_k', 'out')" class="flex items-center justify-center space-x-3 p-3 bg-white hover:bg-pink-50 border border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 group">
                        <div class="w-5 h-5 rounded-full border-2 border-purple-500 flex items-center justify-center text-[10px] font-bold text-purple-600">K<sup>+</sup></div>
                        <span class="font-medium text-slate-700 group-hover:text-pink-600">é‰€é›¢å­ (\(K^+\))</span>
                    </button>
                </div>
            </div>

        </div>

        <!-- Simulation Canvas Area -->
        <div class="relative w-full h-[400px] bg-gradient-to-b from-blue-50 via-white to-pink-50 overflow-hidden select-none" id="canvas-container">
            
            <!-- Labels (Absolute Positioned) -->
            <div class="absolute top-2 left-2 bg-blue-100/80 px-2 py-1 rounded text-xs text-blue-800 font-bold border border-blue-200 z-10">
                ç´°èƒå¤– (Extracellular)
            </div>
            <div class="absolute bottom-2 left-2 bg-pink-100/80 px-2 py-1 rounded text-xs text-pink-800 font-bold border border-pink-200 z-10">
                ç´°èƒå…§ (Intracellular)
            </div>

            <!-- SVG Layer for Membrane Structure -->
            <svg id="membrane-svg" class="w-full h-full absolute top-0 left-0" preserveAspectRatio="none">
                <!-- Content generated by JS -->
            </svg>

            <!-- Particles Layer -->
            <div id="particle-layer" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>

            <!-- Labels for Structure (Floating) -->
            <div class="absolute top-[135px] right-[10%] text-xs bg-white/90 px-2 py-1 rounded shadow pointer-events-none border border-slate-300">
                <span class="block font-bold text-blue-600">è¦ªæ°´æ€§é ­éƒ¨</span>
            </div>
            <div class="absolute top-[245px] right-[10%] text-xs bg-white/90 px-2 py-1 rounded shadow pointer-events-none border border-slate-300">
                <span class="block font-bold text-yellow-600">ç–æ°´æ€§å°¾éƒ¨</span>
            </div>
            <div class="absolute top-[190px] left-[52%] transform -translate-x-1/2 text-xs bg-purple-100/90 px-2 py-1 rounded shadow pointer-events-none border border-purple-300 text-center">
                <span class="block font-bold text-purple-700">é‹è¼¸è›‹ç™½</span>
            </div>
        </div>

        <!-- Explanation / Feedback Box -->
        <div class="bg-slate-50 p-6 border-t border-slate-200 min-h-[160px]">
            <div class="flex items-start space-x-4">
                <div class="hidden md:block text-4xl pt-1">ğŸ’¡</div>
                <div class="flex-1">
                    <h3 id="info-title" class="text-lg font-bold text-slate-800 mb-2">è«‹é¸æ“‡ä¸Šæ–¹ç‰©è³ªé€²è¡Œå¯¦é©—</h3>
                    <div id="info-text" class="text-slate-600 leading-relaxed text-sm md:text-base">
                        ç´°èƒè†œç”±ç£·è„‚é›™åˆ†å­å±¤çµ„æˆï¼Œå…·æœ‰ã€Œé¸æ“‡æ€§é€æ€§ã€ã€‚è«‹é»æ“ŠæŒ‰éˆ•è§€å¯Ÿç‰©è³ªå¦‚ä½•é€²å…¥æˆ–é›¢é–‹ç´°èƒã€‚
                    </div>
                    <div id="info-tag" class="mt-3 inline-block px-3 py-1 rounded-full text-sm font-medium hidden"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-8 text-center text-slate-400 text-sm">
        <p>Biology Interactive Tool Â© 2024</p>
    </footer>

    <script>
        // Configuration
        const membraneY = 160; // Top of membrane
        const membraneHeight = 80; // Thickness of lipid bilayer
        const proteinCenter = 50; // Percentage X
        const proteinWidthPercent = 10; // Width of protein channel in %

        // State
        let particles = [];
        let animationId;
        const svg = document.getElementById('membrane-svg');
        const particleLayer = document.getElementById('particle-layer');
        const infoTitle = document.getElementById('info-title');
        const infoText = document.getElementById('info-text');
        const infoTag = document.getElementById('info-tag');

        // Initialization
        window.onload = function() {
            drawMembrane();
            animate();
            // Force MathJax to render initial static content
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        };

        window.onresize = function() {
            svg.innerHTML = ''; 
            drawMembrane();
        }

        // 1. Drawing the Membrane Structure
        function drawMembrane() {
            const width = svg.clientWidth;
            const lipidWidth = 25;
            const count = Math.ceil(width / lipidWidth);
            
            // Calculate Protein Gap
            const pCenterPx = width * (proteinCenter / 100);
            const pHalfWidthPx = (width * (proteinWidthPercent / 100)) / 2;
            const gapStart = pCenterPx - pHalfWidthPx;
            const gapEnd = pCenterPx + pHalfWidthPx;

            let lipidHTML = '';

            for (let i = 0; i < count; i++) {
                const x = i * lipidWidth + (lipidWidth/2);
                if (x > gapStart && x < gapEnd) continue;
                // Top Layer
                lipidHTML += createLipid(x, membraneY, false);
                // Bottom Layer
                lipidHTML += createLipid(x, membraneY + membraneHeight, true);
            }

            // Draw Protein Channel
            const proteinPath = `
                M ${gapStart + 5}, ${membraneY - 10} 
                L ${gapStart + 5}, ${membraneY + membraneHeight + 10} 
                Q ${gapStart + 5}, ${membraneY + membraneHeight + 20} ${gapStart + 20}, ${membraneY + membraneHeight + 20}
                L ${gapEnd - 20}, ${membraneY + membraneHeight + 20}
                Q ${gapEnd - 5}, ${membraneY + membraneHeight + 20} ${gapEnd - 5}, ${membraneY + membraneHeight + 10}
                L ${gapEnd - 5}, ${membraneY - 10}
                Q ${gapEnd - 5}, ${membraneY - 20} ${gapEnd - 20}, ${membraneY - 20}
                L ${gapStart + 20}, ${membraneY - 20}
                Q ${gapStart + 5}, ${membraneY - 20} ${gapStart + 5}, ${membraneY - 10}
                Z
            `;
            
            // Channel pore (visual only)
            const porePath = `
                M ${pCenterPx - 5}, ${membraneY - 20}
                L ${pCenterPx - 5}, ${membraneY + membraneHeight + 20}
                L ${pCenterPx + 5}, ${membraneY + membraneHeight + 20}
                L ${pCenterPx + 5}, ${membraneY - 20}
                Z
            `;

            lipidHTML += `<path d="${proteinPath}" class="protein" opacity="0.9" />`;
            lipidHTML += `<path d="${porePath}" fill="#7C3AED" opacity="0.3" />`;

            svg.innerHTML = lipidHTML;
        }

        function createLipid(x, y, isBottom) {
            const tailLength = 35;
            const headRadius = 8;
            const direction = isBottom ? -1 : 1;
            const tailWiggle1 = Math.random() * 6 - 3;
            const tailWiggle2 = Math.random() * 6 - 3;

            return `
                <line x1="${x-3}" y1="${y}" x2="${x-3 + tailWiggle1}" y2="${y + (tailLength * direction)}" class="lipid-tail" />
                <line x1="${x+3}" y1="${y}" x2="${x+3 + tailWiggle2}" y2="${y + (tailLength * direction)}" class="lipid-tail" />
                <circle cx="${x}" cy="${y}" r="${headRadius}" class="lipid-head" />
            `;
        }

        // 2. Simulation Logic
        function startSimulation(type, direction = 'in') {
            updateInfoBox(type, direction);
            
            let count = 0;
            const interval = setInterval(() => {
                spawnParticle(type, direction);
                count++;
                if(count >= 8) clearInterval(interval);
            }, 300);
        }

        function spawnParticle(type, direction) {
            const el = document.createElement('div');
            el.className = 'absolute transition-transform';
            
            const startXPercent = Math.random() * 90 + 5; 
            const containerWidth = particleLayer.clientWidth;
            const containerHeight = particleLayer.clientHeight;
            const xPos = (startXPercent / 100) * containerWidth;
            
            let startY, initialVy;

            if (direction === 'in') {
                startY = -30;
                initialVy = 1.5 + Math.random(); // Moving Down
            } else {
                startY = containerHeight + 10; // Start from bottom
                initialVy = -(1.5 + Math.random()); // Moving Up (negative Y)
            }

            // Style based on type
            if (type === 'oxygen') {
                el.innerHTML = '<div class="w-4 h-4 rounded-full bg-red-500 shadow-sm opacity-90"></div>';
            } else if (type === 'water') {
                el.innerHTML = '<div class="w-3 h-3 rounded-full bg-blue-400 shadow-sm opacity-80"></div>';
            } else if (type === 'glucose') {
                el.innerHTML = '<div class="w-6 h-6 bg-green-100 border-2 border-green-600 rotate-45 shadow-sm"></div>';
            } else if (type === 'ion_na') {
                el.innerHTML = '<div class="w-5 h-5 rounded-full bg-white border-2 border-orange-500 text-[10px] flex items-center justify-center font-bold text-orange-600 leading-none pb-[1px]">Na<sup>+</sup></div>';
            } else if (type === 'co2') {
                el.innerHTML = '<div class="w-5 h-4 rounded-lg bg-gray-500 shadow-sm opacity-90"></div>';
            } else if (type === 'ion_k') {
                el.innerHTML = '<div class="w-5 h-5 rounded-full bg-white border-2 border-purple-500 text-[10px] flex items-center justify-center font-bold text-purple-600 leading-none pb-[1px]">K<sup>+</sup></div>';
            }

            el.style.left = xPos + 'px';
            el.style.top = startY + 'px';
            
            particleLayer.appendChild(el);

            particles.push({
                element: el,
                type: type,
                x: xPos,
                y: startY,
                vx: 0,
                vy: initialVy,
                active: true,
                passed: false,
                direction: direction // 'in' or 'out'
            });
        }

        function animate() {
            const containerWidth = particleLayer.clientWidth;
            const containerHeight = particleLayer.clientHeight;
            const pCenterPx = containerWidth * (proteinCenter / 100);
            const pHalfWidthPx = (containerWidth * (proteinWidthPercent / 100)) / 2;
            const gapStart = pCenterPx - pHalfWidthPx + 10;
            const gapEnd = pCenterPx + pHalfWidthPx - 10;

            particles.forEach((p, index) => {
                if (!p.active) return;

                p.y += p.vy;
                
                // Brownian motion
                if(p.type !== 'glucose') { 
                    p.x += (Math.random() - 0.5) * 1; 
                }
                
                const membraneTop = membraneY - 10;
                const membraneBottom = membraneY + membraneHeight + 10;

                // COLLISION LOGIC
                // Check if particle is currently INSIDE the vertical band of the membrane
                if (p.y > membraneTop && p.y < membraneBottom && !p.passed) {
                    
                    const isOverChannel = (p.x > gapStart && p.x < gapEnd);

                    if (isOverChannel) {
                        // Facilitated Diffusion / Channel
                        // Accelerate through channel
                        p.vy = (p.direction === 'in') ? 2.5 : -2.5; 
                        p.x += (pCenterPx - p.x) * 0.1; // Attraction to center
                    } else {
                        // Hitting the Lipid Bilayer
                        
                        // Permeable substances
                        if (p.type === 'oxygen' || p.type === 'co2') {
                            // Simple Diffusion
                            // Slow down slightly in lipid
                            p.vy = (p.direction === 'in') ? 1.2 : -1.2;
                        } else if (p.type === 'water') {
                            // Osmosis (Simplified)
                            p.vy = (p.direction === 'in') ? 0.8 : -0.8;
                        } else {
                            // Impermeable substances (Glucose, Ions) -> Bounce
                            p.vy = -p.vy * 1.5; // Reverse direction and fast bounce
                            p.element.classList.add('fade-out');
                            p.active = false;
                            
                            setTimeout(() => {
                                if(p.element.parentNode) p.element.parentNode.removeChild(p.element);
                            }, 500);
                        }
                    }
                }

                // Update DOM
                p.element.style.top = p.y + 'px';
                p.element.style.left = p.x + 'px';

                // Cleanup off screen
                if (p.y > containerHeight + 50 || p.y < -50) {
                    p.active = false;
                    if(p.element.parentNode) p.element.parentNode.removeChild(p.element);
                }
            });

            particles = particles.filter(p => p.active || p.element.classList.contains('fade-out'));
            requestAnimationFrame(animate);
        }

        // 3. Educational Content Logic
        function updateInfoBox(type, direction) {
            infoTag.classList.remove('hidden');
            let title = "", desc = "", tagText = "", tagColor = "";

            if (type === 'oxygen') {
                title = "æ°§æ°£ \\(O_2\\) - ç°¡å–®æ“´æ•£";
                desc = "æ°§æ°£æ˜¯éæ¥µæ€§åˆ†å­ã€‚é›–ç„¶ç´°èƒè†œçš„ä¸­å¿ƒæ˜¯ç–æ°´æ€§çš„ï¼Œä½†æ°§æ°£å¯ä»¥é †è‘—æ¿ƒåº¦æ¢¯åº¦ç›´æ¥ç©¿é€ç£·è„‚é›™åˆ†å­å±¤é€²å…¥ç´°èƒï¼Œä¸éœ€è¦è€—èƒ½ä¹Ÿä¸éœ€è¦è¼‰é«”ã€‚";
                tagText = "å¯è‡ªç”±ç©¿é€";
                tagColor = "bg-green-100 text-green-800";
            } else if (type === 'water') {
                title = "æ°´ \\(H_2O\\) - æ»²é€ä½œç”¨";
                desc = "æ°´æ˜¯æ¥µæ€§åˆ†å­ï¼Œä½†åˆ†å­å¾ˆå°ã€‚å®ƒå¯ä»¥ç·©æ…¢é€šéç£·è„‚å±¤ï¼Œæˆ–æ›´å¿«é€Ÿåœ°é€šéç‰¹å®šçš„**æ°´é€šé“è›‹ç™½ (Aquaporins)** é€²å…¥ç´°èƒã€‚";
                tagText = "éƒ¨åˆ†ç©¿é€ / éœ€é€šé“";
                tagColor = "bg-blue-100 text-blue-800";
            } else if (type === 'glucose') {
                title = "è‘¡è„ç³– (Glucose) - ä¿ƒé€²æ€§æ“´æ•£";
                desc = "è‘¡è„ç³–æ˜¯å¤§åˆ†å­ä¸”å…·æ¥µæ€§ï¼Œç„¡æ³•é€šéç–æ°´æ€§çš„ç£·è„‚å±¤ã€‚å®ƒå¿…é ˆä¾é ç´°èƒè†œä¸Šçš„**è¼‰é«”è›‹ç™½**æ”¹è®Šå½¢ç‹€ä¾†é‹é€é€²å…¥ç´°èƒã€‚è‹¥æœªå°æº–é€šé“ï¼Œå‰‡ç„¡æ³•é€²å…¥ã€‚";
                tagText = "éœ€è¼‰é«”è›‹ç™½";
                tagColor = "bg-yellow-100 text-yellow-800";
            } else if (type === 'ion_na') {
                title = "éˆ‰é›¢å­ \\(Na^+\\) - é›¢å­é€šé“";
                desc = "å¸¶é›»è·çš„ \\(Na^+\\) æ¥µåº¦è¦ªæ°´ï¼Œæœƒè¢«è†œå…§çš„ç–æ°´å°¾éƒ¨æ’æ–¥ã€‚å®ƒå¿…é ˆé€šéå°ˆé–€çš„**é›¢å­é€šé“**æ‰èƒ½é€²å…¥ç´°èƒã€‚";
                tagText = "éœ€é€šé“è›‹ç™½";
                tagColor = "bg-orange-100 text-orange-800";
            } else if (type === 'co2') {
                title = "äºŒæ°§åŒ–ç¢³ \\(CO_2\\) - å»¢ç‰©æ’å‡º";
                desc = "ç´°èƒå‘¼å¸æœƒç”¢ç”Ÿä»£è¬å»¢ç‰© \\(CO_2\\)ã€‚å°±åƒæ°§æ°£ä¸€æ¨£ï¼Œå®ƒæ˜¯éæ¥µæ€§å°åˆ†å­ï¼Œå¯ä»¥å¾ç´°èƒå…§ï¼ˆé«˜æ¿ƒåº¦ï¼‰ç›´æ¥ç©¿éç£·è„‚å±¤æ“´æ•£åˆ°ç´°èƒå¤–ï¼ˆä½æ¿ƒåº¦ï¼‰ã€‚";
                tagText = "å¯è‡ªç”±ç©¿é€ (æ’å‡º)";
                tagColor = "bg-gray-200 text-gray-800";
            } else if (type === 'ion_k') {
                title = "é‰€é›¢å­ \\(K^+\\) - é›¢å­æµå‡º";
                desc = "ç´°èƒå…§éƒ¨çš„ \\(K^+\\) æ¿ƒåº¦é€šå¸¸è¼ƒé«˜ã€‚å®ƒå¯ä»¥é€é**é‰€é›¢å­é€šé“**ï¼ˆå¦‚æ»²æ¼é€šé“ï¼‰é †æ¿ƒåº¦æ¢¯åº¦æ“´æ•£å‡ºç´°èƒã€‚å› ç‚ºå¸¶é›»ï¼Œå®ƒç„¡æ³•ç›´æ¥ç©¿éç£·è„‚å±¤ã€‚";
                tagText = "éœ€é€šé“è›‹ç™½ (æ’å‡º)";
                tagColor = "bg-purple-100 text-purple-800";
            }

            infoTitle.innerHTML = title;
            infoText.innerHTML = desc;
            infoTag.innerText = tagText;
            infoTag.className = `mt-3 inline-block px-3 py-1 rounded-full text-sm font-medium ${tagColor}`;

            // Trigger MathJax re-render
            if (window.MathJax) {
                MathJax.typesetPromise([infoTitle, infoText, infoTag]);
            }
        }
    </script>
</body>
</html>