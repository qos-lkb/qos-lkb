<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>原子結構互動模擬 (Atomic Structure Simulation)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .element-btn:hover {
            transform: scale(1.05);
        }
        .element-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        .isotope-btn {
            transition: all 0.2s;
        }
        .isotope-btn.active {
            background-color: #f59e0b; /* amber-500 */
            color: white;
            border-color: #d97706;
            font-weight: bold;
        }
        canvas {
            background: radial-gradient(circle, #ffffff 0%, #f3f4f6 100%);
            border-radius: 1rem;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-sm py-3 px-6 flex justify-between items-center shrink-0 z-10">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">Li</div>
            <h1 class="text-xl font-bold text-slate-700">原子結構與次原子模擬器</h1>
        </div>
        <div class="text-sm text-slate-500">化學科教學工具</div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- Left Panel: Controls & Stats -->
        <aside class="w-full md:w-1/3 lg:w-1/4 bg-white border-r border-slate-200 flex flex-col overflow-y-auto p-4 gap-4 shadow-lg z-10">
            
            <!-- Element Selection Grid -->
            <div class="bg-slate-50 p-3 rounded-xl border border-slate-200">
                <h2 class="text-sm font-semibold text-slate-500 mb-3 uppercase tracking-wide">1. 選擇元素 (1-20)</h2>
                <div id="element-grid" class="grid grid-cols-5 gap-2">
                    <!-- Buttons generated by JS -->
                </div>
            </div>

            <!-- Isotope Selection (New Feature) -->
            <div class="bg-amber-50 p-3 rounded-xl border border-amber-100 animate-fade-in">
                <h2 class="text-sm font-semibold text-amber-700 mb-2 uppercase tracking-wide flex items-center gap-2">
                    2. 選擇同位素 (Isotopes)
                </h2>
                <div id="isotope-container" class="flex flex-wrap gap-2">
                    <!-- Isotope buttons generated by JS -->
                </div>
                <p class="text-xs text-amber-600 mt-2">
                    * 切換同位素會改變中子數與質量數
                </p>
            </div>

            <!-- Stats Display -->
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex-1 flex flex-col justify-center min-h-[200px]">
                <h2 class="text-lg font-bold text-blue-800 mb-4 flex items-center gap-2">
                    <span class="w-2 h-6 bg-blue-600 rounded-full"></span>
                    次原子數據
                </h2>
                
                <div class="space-y-3">
                    <div class="flex justify-between items-center border-b border-blue-200 pb-2">
                        <span class="text-slate-600">原子序 (Z)</span>
                        <span id="stat-atomic-num" class="font-mono text-xl font-bold text-slate-800">1</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-blue-200 pb-2">
                        <span class="text-slate-600">質量數 (A)</span>
                        <div class="flex items-center gap-2">
                            <span id="stat-mass-num" class="font-mono text-xl font-bold text-slate-800 transition-all duration-300">1</span>
                            <span class="text-xs bg-slate-200 px-1.5 py-0.5 rounded text-slate-600">p⁺ + n⁰</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <div class="bg-white p-2 rounded-lg text-center shadow-sm border border-red-100">
                            <div class="text-xs text-red-500 font-bold mb-1">質子 (p⁺)</div>
                            <div id="stat-protons" class="text-2xl font-bold text-red-600">1</div>
                        </div>
                        <div class="bg-white p-2 rounded-lg text-center shadow-sm border border-slate-200 relative overflow-hidden">
                            <!-- Background indicator for change -->
                            <div id="neutron-flash" class="absolute inset-0 bg-slate-300 opacity-0 pointer-events-none transition-opacity duration-300"></div>
                            <div class="text-xs text-slate-500 font-bold mb-1 relative z-10">中子 (n⁰)</div>
                            <div id="stat-neutrons" class="text-2xl font-bold text-slate-600 relative z-10 transition-transform duration-200">0</div>
                        </div>
                        <div class="bg-white p-2 rounded-lg text-center shadow-sm border border-yellow-200">
                            <div class="text-xs text-yellow-600 font-bold mb-1">電子 (e⁻)</div>
                            <div id="stat-electrons" class="text-2xl font-bold text-yellow-600">1</div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Right Panel: Visualization -->
        <section class="flex-1 bg-slate-100 p-4 flex flex-col relative overflow-hidden">
            
            <!-- Canvas Container -->
            <div class="flex-1 relative bg-white rounded-2xl shadow-inner border border-slate-200 overflow-hidden flex items-center justify-center">
                <canvas id="atomCanvas" class="max-w-full max-h-full"></canvas>
                
                <!-- Legend -->
                <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm p-3 rounded-lg shadow border border-slate-100 text-xs space-y-2 pointer-events-none select-none">
                    <div class="font-bold text-slate-400 mb-1 border-b border-slate-100 pb-1">圖例 Legend</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500 shadow-sm"></span> 質子 (Proton)</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-slate-400 shadow-sm"></span> 中子 (Neutron)</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-yellow-400 border border-yellow-600 shadow-sm animate-pulse"></span> 電子 (Electron)</div>
                </div>
            </div>

            <!-- Info Bar -->
            <div class="mt-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4 shrink-0">
                <div class="text-center sm:text-left">
                    <div class="text-3xl font-bold text-slate-800 flex items-baseline justify-center sm:justify-start">
                        <span id="display-symbol" class="text-blue-600 mr-2">H</span>
                        <span id="display-name-zh">氫</span>
                        <span id="display-isotope-mass" class="text-sm text-slate-400 ml-2 font-mono align-top border border-slate-200 px-1 rounded">-1</span>
                    </div>
                    <div id="display-name-en" class="text-slate-500 font-medium">Hydrogen</div>
                </div>
                
                <div class="flex flex-col items-center sm:items-end">
                    <div class="text-sm text-slate-500 uppercase tracking-wider mb-1">電子排佈 (Electron Config)</div>
                    <div id="display-config" class="text-2xl font-mono font-bold text-slate-800 bg-slate-100 px-4 py-1 rounded-lg">
                        1
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- Data: First 20 Elements with Common Isotopes ---
        const elements = [
            { 
                z: 1, symbol: 'H', nameEn: 'Hydrogen', nameZh: '氫', 
                isotopes: [
                    { mass: 1, name: 'H-1 (氕)' },
                    { mass: 2, name: 'H-2 (氘)' },
                    { mass: 3, name: 'H-3 (氚)' }
                ]
            },
            { 
                z: 2, symbol: 'He', nameEn: 'Helium', nameZh: '氦',
                isotopes: [
                    { mass: 4, name: 'He-4' },
                    { mass: 3, name: 'He-3' }
                ]
            },
            { 
                z: 3, symbol: 'Li', nameEn: 'Lithium', nameZh: '鋰',
                isotopes: [
                    { mass: 7, name: 'Li-7' },
                    { mass: 6, name: 'Li-6' }
                ]
            },
            { 
                z: 4, symbol: 'Be', nameEn: 'Beryllium', nameZh: '鈹',
                isotopes: [ { mass: 9, name: 'Be-9' } ]
            },
            { 
                z: 5, symbol: 'B', nameEn: 'Boron', nameZh: '硼',
                isotopes: [
                    { mass: 11, name: 'B-11' },
                    { mass: 10, name: 'B-10' }
                ]
            },
            { 
                z: 6, symbol: 'C', nameEn: 'Carbon', nameZh: '碳',
                isotopes: [
                    { mass: 12, name: 'C-12' },
                    { mass: 13, name: 'C-13' },
                    { mass: 14, name: 'C-14' }
                ]
            },
            { 
                z: 7, symbol: 'N', nameEn: 'Nitrogen', nameZh: '氮',
                isotopes: [
                    { mass: 14, name: 'N-14' },
                    { mass: 15, name: 'N-15' }
                ]
            },
            { 
                z: 8, symbol: 'O', nameEn: 'Oxygen', nameZh: '氧',
                isotopes: [
                    { mass: 16, name: 'O-16' },
                    { mass: 17, name: 'O-17' },
                    { mass: 18, name: 'O-18' }
                ]
            },
            { 
                z: 9, symbol: 'F', nameEn: 'Fluorine', nameZh: '氟',
                isotopes: [ { mass: 19, name: 'F-19' } ]
            },
            { 
                z: 10, symbol: 'Ne', nameEn: 'Neon', nameZh: '氖',
                isotopes: [
                    { mass: 20, name: 'Ne-20' },
                    { mass: 21, name: 'Ne-21' },
                    { mass: 22, name: 'Ne-22' }
                ]
            },
            { 
                z: 11, symbol: 'Na', nameEn: 'Sodium', nameZh: '鈉',
                isotopes: [ { mass: 23, name: 'Na-23' } ]
            },
            { 
                z: 12, symbol: 'Mg', nameEn: 'Magnesium', nameZh: '鎂',
                isotopes: [
                    { mass: 24, name: 'Mg-24' },
                    { mass: 25, name: 'Mg-25' },
                    { mass: 26, name: 'Mg-26' }
                ]
            },
            { 
                z: 13, symbol: 'Al', nameEn: 'Aluminium', nameZh: '鋁',
                isotopes: [ { mass: 27, name: 'Al-27' } ]
            },
            { 
                z: 14, symbol: 'Si', nameEn: 'Silicon', nameZh: '矽',
                isotopes: [
                    { mass: 28, name: 'Si-28' },
                    { mass: 29, name: 'Si-29' },
                    { mass: 30, name: 'Si-30' }
                ]
            },
            { 
                z: 15, symbol: 'P', nameEn: 'Phosphorus', nameZh: '磷',
                isotopes: [ { mass: 31, name: 'P-31' } ]
            },
            { 
                z: 16, symbol: 'S', nameEn: 'Sulfur', nameZh: '硫',
                isotopes: [
                    { mass: 32, name: 'S-32' },
                    { mass: 33, name: 'S-33' },
                    { mass: 34, name: 'S-34' },
                    { mass: 36, name: 'S-36' }
                ]
            },
            { 
                z: 17, symbol: 'Cl', nameEn: 'Chlorine', nameZh: '氯',
                isotopes: [
                    { mass: 35, name: 'Cl-35' },
                    { mass: 37, name: 'Cl-37' }
                ]
            },
            { 
                z: 18, symbol: 'Ar', nameEn: 'Argon', nameZh: '氬',
                isotopes: [
                    { mass: 40, name: 'Ar-40' },
                    { mass: 36, name: 'Ar-36' },
                    { mass: 38, name: 'Ar-38' }
                ]
            },
            { 
                z: 19, symbol: 'K', nameEn: 'Potassium', nameZh: '鉀',
                isotopes: [
                    { mass: 39, name: 'K-39' },
                    { mass: 41, name: 'K-41' },
                    { mass: 40, name: 'K-40' }
                ]
            },
            { 
                z: 20, symbol: 'Ca', nameEn: 'Calcium', nameZh: '鈣',
                isotopes: [
                    { mass: 40, name: 'Ca-40' },
                    { mass: 44, name: 'Ca-44' },
                    { mass: 42, name: 'Ca-42' },
                    { mass: 48, name: 'Ca-48' }
                ]
            }
        ];

        // --- State ---
        let currentElementIndex = 0;
        let currentIsotopeIndex = 0;
        const canvas = document.getElementById('atomCanvas');
        const ctx = canvas.getContext('2d');
        let animationFrameId;
        let electronAngleOffset = 0;

        // --- Initialization ---
        function init() {
            createGrid();
            resizeCanvas();
            selectElement(0); // Default to Hydrogen
            window.addEventListener('resize', () => {
                resizeCanvas();
                drawAtom();
            });
            animate();
        }

        // --- Helper: Electron Configuration Calculation ---
        function getElectronConfig(z) {
            const shells = [];
            let remaining = z;
            
            // Shell 1 (K): max 2
            let shell1 = Math.min(2, remaining);
            if(shell1 > 0) shells.push(shell1);
            remaining -= shell1;
            
            // Shell 2 (L): max 8
            if (remaining > 0) {
                let shell2 = Math.min(8, remaining);
                shells.push(shell2);
                remaining -= shell2;
            }
            
            // Shell 3 (M): max 8 (for first 20 elements)
            if (remaining > 0) {
                let shell3 = Math.min(8, remaining);
                shells.push(shell3);
                remaining -= shell3;
            }

            // Shell 4 (N): remaining
            if (remaining > 0) {
                shells.push(remaining);
            }
            
            return shells;
        }

        // --- UI Construction ---
        function createGrid() {
            const grid = document.getElementById('element-grid');
            elements.forEach((el, index) => {
                const btn = document.createElement('button');
                btn.className = `element-btn w-full aspect-square flex flex-col items-center justify-center rounded-lg border bg-white border-slate-200 text-slate-700 transition-all duration-200`;
                btn.innerHTML = `
                    <span class="text-[10px] leading-none opacity-60">${el.z}</span>
                    <span class="font-bold text-lg leading-tight">${el.symbol}</span>
                `;
                btn.onclick = () => selectElement(index);
                btn.id = `btn-${index}`;
                grid.appendChild(btn);
            });
        }

        function createIsotopeSelectors(element) {
            const container = document.getElementById('isotope-container');
            container.innerHTML = ''; // Clear previous

            element.isotopes.forEach((iso, index) => {
                const btn = document.createElement('button');
                btn.className = `isotope-btn flex-1 min-w-[60px] py-1 px-2 text-xs border rounded bg-white border-slate-300 text-slate-600 hover:bg-slate-50`;
                // Show mass number, e.g., "12" or name "C-12"
                btn.textContent = iso.name.split(' ')[0]; // Simplified name for button
                btn.title = iso.name; // Full name on hover
                btn.onclick = () => selectIsotope(index);
                btn.id = `iso-btn-${index}`;
                container.appendChild(btn);
            });
        }

        function selectElement(index) {
            // UI Update for Element Grid
            document.querySelectorAll('.element-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${index}`).classList.add('active');

            currentElementIndex = index;
            currentIsotopeIndex = 0; // Reset to most common isotope

            // Update Isotope UI
            const el = elements[currentElementIndex];
            createIsotopeSelectors(el);
            selectIsotope(0); // Trigger updateStats and draw
        }

        function selectIsotope(index) {
            currentIsotopeIndex = index;

            // UI Update for Isotope Buttons
            document.querySelectorAll('.isotope-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`iso-btn-${index}`).classList.add('active');

            updateStats();
            drawAtom();
        }

        function updateStats() {
            const el = elements[currentElementIndex];
            const isotope = el.isotopes[currentIsotopeIndex];
            
            const protons = el.z;
            const mass = isotope.mass;
            const neutrons = mass - protons;
            const electrons = protons; // Neutral atom
            const config = getElectronConfig(protons);

            // Update DOM
            document.getElementById('stat-atomic-num').textContent = el.z;
            document.getElementById('stat-mass-num').textContent = mass;
            document.getElementById('stat-protons').textContent = protons;
            
            // Visual feedback for neutron change
            const neutronEl = document.getElementById('stat-neutrons');
            if (neutronEl.textContent != neutrons) {
                const flash = document.getElementById('neutron-flash');
                flash.style.opacity = '0.5';
                setTimeout(() => flash.style.opacity = '0', 300);
            }
            neutronEl.textContent = neutrons;
            
            document.getElementById('stat-electrons').textContent = electrons;
            
            document.getElementById('display-symbol').textContent = el.symbol;
            document.getElementById('display-name-zh').textContent = el.nameZh;
            document.getElementById('display-name-en').textContent = el.nameEn;
            document.getElementById('display-config').textContent = config.join(', ');
            
            // Update Mass Indicator in Title
            document.getElementById('display-isotope-mass').textContent = "-" + mass;
        }

        // --- Visualization Logic ---
        function resizeCanvas() {
            const parent = canvas.parentElement;
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;
        }

        function animate() {
            electronAngleOffset += 0.005; // Rotation speed
            drawAtom();
            animationFrameId = requestAnimationFrame(animate);
        }

        function drawAtom() {
            if (!ctx) return;
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            
            const el = elements[currentElementIndex];
            const isotope = el.isotopes[currentIsotopeIndex];

            const protons = el.z;
            const neutrons = isotope.mass - protons;
            const config = getElectronConfig(protons);

            ctx.clearRect(0, 0, width, height);

            // 1. Draw Nucleus with Z-sorted 3D Packing
            const particleRadius = 7; 
            // Base nucleus radius for positioning shells
            // Reduced multiplier (1.5 -> 1.2) because nucleus is now more compact
            const baseNucleusRadius = Math.max(10, Math.pow(isotope.mass, 1/3) * particleRadius * 1.2); 

            drawPackedNucleus(centerX, centerY, protons, neutrons, particleRadius);

            // 2. Draw Shells and Electrons
            const maxRadius = Math.min(width, height) / 2 - 20;
            const firstShellRadius = baseNucleusRadius + 35; // Adjusted offset
            const shellSpacing = (maxRadius - firstShellRadius) / 3.5; 

            config.forEach((count, shellIndex) => {
                const shellRadius = firstShellRadius + (shellIndex * shellSpacing);
                
                // Draw Orbit Path
                ctx.beginPath();
                ctx.arc(centerX, centerY, shellRadius, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(148, 163, 184, 0.4)'; 
                ctx.lineWidth = 1.5;
                ctx.stroke();

                // Draw Electrons
                for (let i = 0; i < count; i++) {
                    const angle = (Math.PI * 2 * i) / count + electronAngleOffset * (shellIndex % 2 === 0 ? 1 : -1); 
                    const ex = centerX + Math.cos(angle) * shellRadius;
                    const ey = centerY + Math.sin(angle) * shellRadius;

                    // Glow
                    ctx.beginPath();
                    ctx.arc(ex, ey, 8, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(250, 204, 21, 0.3)'; 
                    ctx.fill();

                    // Core
                    ctx.beginPath();
                    ctx.arc(ex, ey, 4, 0, Math.PI * 2);
                    const grad = ctx.createRadialGradient(ex-1, ey-1, 1, ex, ey, 4);
                    grad.addColorStop(0, '#fde047'); 
                    grad.addColorStop(1, '#eab308'); 
                    ctx.fillStyle = grad;
                    ctx.fill();
                    ctx.strokeStyle = '#854d0e'; 
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            });
        }

        // Improved Spherical Packing with Z-Sorting
        function drawPackedNucleus(cx, cy, numProtons, numNeutrons, pRadius) {
            const rawParticles = [];
            for(let i=0; i<numProtons; i++) rawParticles.push({type: 'proton'});
            for(let i=0; i<numNeutrons; i++) rawParticles.push({type: 'neutron'});
            
            // Deterministic shuffle
            const seed = currentElementIndex * 1000 + currentIsotopeIndex * 100;
            shuffleArray(rawParticles, seed);

            const particles3D = [];
            let particleIndex = 0;
            let layerIndex = 0;
            
            // Use Fibonacci Sphere algorithm on multiple layers to fill the volume
            while (particleIndex < rawParticles.length) {
                // Layer capacities approximated for dense packing
                let capacity = 1;
                if (layerIndex > 0) {
                    // Increased density factor (0.8 -> 0.6 logic was inverted, we want higher capacity for same radius? 
                    // No, we rely on layerIndex. 
                    // Packing Formula: Area ~ 4*PI*R^2. R=layerIndex.
                    // Previous was manual overrides. Now use formula to fill shells more naturally.
                    // Using factor 0.6 ensures we pack reasonably tight without strict geometric locking.
                    capacity = Math.floor(4 * Math.PI * Math.pow(layerIndex, 2) * 0.6); 
                }
                // Don't exceed remaining particles
                const countInLayer = Math.min(capacity, rawParticles.length - particleIndex);
                
                // Radius of this shell - TIGHTER spacing (1.6 -> 1.3)
                // This makes particles overlap slightly, creating a solid ball look
                const layerRadius = Math.max(0, layerIndex * pRadius * 1.3);

                // Fibonacci Spiral Constants
                const phi = Math.PI * (3 - Math.sqrt(5)); // Golden angle

                for (let i = 0; i < countInLayer; i++) {
                    // Y goes from 1 to -1
                    const y = 1 - (i / (countInLayer - 1 + 0.0001)) * 2; 
                    const radiusAtY = Math.sqrt(1 - y * y);
                    
                    const theta = phi * i;
                    
                    // Add rotational jitter based on layer to avoid "lines" looking artificial
                    const layerRotation = layerIndex * 15; 

                    let xPos = Math.cos(theta + layerRotation) * radiusAtY;
                    let zPos = Math.sin(theta + layerRotation) * radiusAtY;
                    let yPos = y;

                    // Handle center point case (count=1)
                    if (countInLayer === 1) { xPos=0; yPos=0; zPos=0; }

                    // Apply jitter: CONSTANT amplitude (not scaling with layer radius)
                    const jitterSeed = seed + particleIndex * 17.3;
                    const jAmp = pRadius * 0.35; // ~2.5px jitter
                    
                    const jx = (Math.sin(jitterSeed) * jAmp);
                    const jy = (Math.cos(jitterSeed * 1.2) * jAmp);
                    const jz = (Math.sin(jitterSeed * 0.8) * jAmp);

                    particles3D.push({
                        // Apply radius scaling to position, THEN add jitter
                        x: xPos * layerRadius + jx,
                        y: yPos * layerRadius + jy,
                        z: zPos * layerRadius + jz,
                        type: rawParticles[particleIndex].type
                    });
                    
                    particleIndex++;
                }
                layerIndex++;
            }

            // CRITICAL STEP: Sort by Z (Depth)
            // Draw particles furthest away (lowest z) first
            particles3D.sort((a, b) => a.z - b.z);

            // Draw them
            particles3D.forEach(p => {
                drawNucleusParticle3D(cx + p.x, cy + p.y, p.z, p.type, pRadius);
            });
        }

        // Simple deterministic shuffle
        function shuffleArray(array, seed) {
            let m = array.length, t, i;
            while (m) {
                // Pseudo-random index
                i = Math.floor((Math.sin(seed + m) * 0.5 + 0.5) * m--);
                t = array[m];
                array[m] = array[i];
                array[i] = t;
            }
        }

        function drawNucleusParticle3D(x, y, z, type, radius) {
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            
            // Light source from top-left-front
            // The gradient center should slightly shift based on z to enhance 3D feel? 
            // For simplicity, fixed light source usually looks robust enough for pixel art style
            const grad = ctx.createRadialGradient(x - radius/3, y - radius/3, radius/5, x, y, radius);

            if (type === 'proton') {
                grad.addColorStop(0, '#fca5a5'); // red-300
                grad.addColorStop(1, '#dc2626'); // red-600
                ctx.strokeStyle = '#991b1b'; // red-800
            } else {
                grad.addColorStop(0, '#cbd5e1'); // slate-300
                grad.addColorStop(1, '#64748b'); // slate-500
                ctx.strokeStyle = '#475569'; // slate-700
            }

            // Depth Shading: Darken particles that are further back
            // Z is typically -radius to +radius. 
            // Map Z to a brightness factor or overlay
            
            ctx.fillStyle = grad;
            ctx.lineWidth = 0.5;
            ctx.fill();

            // Atmospheric perspective / Depth shadow
            // If z < 0 (back), add a slight dark overlay
            if (z < 0) {
               ctx.fillStyle = `rgba(0, 0, 0, ${Math.abs(z) / (radius * 8)})`; // Subtle shadow
               ctx.fill();
            }
            // If z > 0 (front), add a slight shine? 
            // (Gradient already handles highlight, so let's keep it simple)

            ctx.stroke();
        }

        // Start
        window.onload = init;

    </script>
</body>
</html>